math.randomseed(os.time())if arg[1]then local function s(e)local e=io.popen("sleep "..e)e:read"*a"return e:close()end local l={{0,1,1,0,1,1},{-1,1,-1,0,1,0},{-1,0,1,0,1,1},{-1,0,0,1,1,0},{-1,1,0,1,1,0},{-1,0,0,1,1,1},{-1,0,1,0,2,0}}function T(t,e,o)if o>1 then return T(-e,t,o-1)end return t,e end local t function fit(i,n,r,o)if n<1 or n>10 or r<1 or t[r][n]~=0 then return end for e=1,6,2 do local e,o=T(l[i][e],l[i][e+1],o)e,o=e+n,o+r if e<1 or e>10 or o<1 or((t[o]or{})[e]or 0)~=0 then return end end return i end function put(e,r,i,n)t[i][r]=e for o=1,6,2 do local n,o=T(l[e][o],l[e][o+1],n)n,o=n+r,o+i;(t[o]or{})[n]=e end end while 1 do os.execute"clear"io.write("\27[0;37m+----------++----+\r\n"..("|          ||    |\r\n"):rep(2).."|          |+----+\r\n|          |Score:\r\n"..("|          |\r\n"):rep(16).."+----------+\27[20F\27[C")t={}for e=1,20 do t[e]={}for o=1,10 do t[e][o]=0 end end local e,o,f,r,a,c,n=20,5,0,math.random(7),math.random(7),0,1 while 1 do f=f+1 s(.1)local d=io.open(arg[1],"rb")or os.exit(0,io.write"\27[49;39m",io.stdout:flush(),os.execute"clear")local i=d:read(1)while i do if i=="a"or i=="h"then if fit(r,o-1,e,n)then o=o-1 end elseif i=="d"or i=="l"then if fit(r,o+1,e,n)then o=o+1 end elseif i=="w"or i=="k"then while fit(r,o,e-1,n)do e=e-1 end elseif i=="s"or i=="j"then if fit(r,o,e,n+1)then n=n%4+1 end end i=d:read(1)end d:close()d=io.open(arg[1],"w")d:write()d:close()if f%(math.max(1,10-math.floor(c/20)))==0 then if fit(r,o,e-1,n)then e=e-1 else put(r,o,e,n)r,e,o,a,n=a,20,5,math.random(7),1 if not fit(r,o,e,n)then break end local e=1 local o=0 while e<21 do local n=1 for o=1,10 do n=n*t[e][o]end if n~=0 then table.remove(t,e)local e={}for o=1,10 do e[o]=0 end table.insert(t,e)o=o+1 else e=e+1 end end c=c+o*o end end put(r,o,e,n)for e=20,1,-1 do for o=1,10 do io.write("\27[3"..t[e][o].."m"..(t[e][o]==0 and" "or"#"))end io.write"\27[E\27[C"end io.write("\27[20F\27[13C\27[3",a,"m")for e=1,0,-1 do for n=-1,2 do local o for t=1,6,2 do if l[a][t]==n and l[a][t+1]==e then io.write"#"o=e end end if e==0 and n==0 then io.write"#"o=e end if not o then io.write" "end end io.write"\27[4D\27[B"end io.write("\27[2B\27[D\27[49;37m",c,"\27[4F\27[C")t[e][o]=0 for i=1,6,2 do local r,n=T(l[r][i],l[r][i+1],n)r,n=r+o,n+e;(t[n]or{})[r]=0 end end io.write"\27[49;39m"io.stdout:flush()os.execute"clear"io.write"\aGame over. Will automatically start new game in 5 seconds. Use ^C to exit"s(5)io.stdout:flush()end else local e=os.tmpname()local o=io.open(e,"w")local n=setmetatable({}, {})getmetatable(n).__gc=function()os.execute"stty -raw echo"end os.execute"stty raw -echo"local t=""i=0 while arg[i]do t=arg[i].." "..t i=i-1 end os.execute(t..e.." &")while 1 do o:close()local t=io.read(1)o=io.open(e,"a")o:write(t)if t=="\3"then o:close()os.remove(e)os.execute"stty -raw echo"getmetatable(n).__gc=nil os.execute"sleep 0.1"os.exit()end end end